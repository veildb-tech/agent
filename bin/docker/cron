#!/usr/bin/env bash

[ -z "$1" ] && echo "Please specify a command (ex. start|stop)" && exit

if [ -z "${PROJECT_ROOT}" ]; then
    export PROJECT_ROOT="$(dirname "$(realpath $0)")/../.."
fi

if [[ ${1} == "setup" ]]; then
    if [[ ! -z ${APP_SERVER_UUID} ]]; then
        "${PROJECT_ROOT}"/bin/docker/docker-compose exec -T -w /app dbvisor_agent_cron bin/console app:cron:install
    else
        echo "To setup cron jobs you must fill APP_SERVER_UUID in ${PROJECT_ROOT}/.env."
    fi
fi

if [[ ${1} == "start" ]]; then
    "${PROJECT_ROOT}"/bin/docker/docker-compose exec -T -w /app dbvisor_agent_cron crond -f
fi

if [[ ${1} == "stop" ]]; then
    "${PROJECT_ROOT}"/bin/docker/docker-compose exec -T -w /app dbvisor_agent_cron pkill crond
fi

if [[ ${1} == "cli" ]]; then
    # shellcheck disable=SC2199
    [[ -z "${@:2}" ]] && echo "Please specify a cli command!" && exit

    "${PROJECT_ROOT}"/bin/docker/docker-compose exec -w /app dbvisor_agent_cron "${@:2}"
fi