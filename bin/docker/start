#!/usr/bin/env bash

if [ -z "${PROJECT_ROOT}" ]; then
    export PROJECT_ROOT="$(dirname "$(realpath $0)")/../.."
fi

if [[ -n ${1} && ${1} == '-b' ]]; then
    "${PROJECT_ROOT}"/bin/docker/docker-compose build --no-cache
fi
"${PROJECT_ROOT}"/bin/docker/docker-compose up -d

# Start required DBs
if [ -f "${PROJECT_ROOT}/.env.mysql" ]; then
    "${PROJECT_ROOT}"/bin/docker/start-db mysql
fi

if [ -f "${PROJECT_ROOT}/.env.postgres" ]; then
    "${PROJECT_ROOT}"/bin/docker/start-db postgres
fi

# Run cron setup after 5 seconds in background
( sleep 5; "${PROJECT_ROOT}"/bin/docker/cron setup > /dev/null 2>&1 ) &