#!/usr/bin/env bash

[ -z "$1" ] && echo "Please specify a Db engine (ex. --mysql|--postgres)" && exit

if [ -z "${PROJECT_ROOT}" ]; then
    export PROJECT_ROOT="$(dirname "$(realpath $0)")/../.."
fi
ENV_FILE=${PROJECT_ROOT}/.env

_startContainer() {
    if [ ! -f ${2} ]; then
        echo "For working DB engine the file ${2} is required!";
        exit;
    fi

    if docker compose version > /dev/null 2>&1; then
      DOCKER_COMPOSE="docker compose"
    else
      DOCKER_COMPOSE="docker-compose"
    fi

    export COMPOSE_IGNORE_ORPHANS=True
    ${DOCKER_COMPOSE} -f "${1}" --env-file "${2}" --env-file "${ENV_FILE}" build --no-cache
    ${DOCKER_COMPOSE} -f "${1}" --env-file "${2}" --env-file "${ENV_FILE}" up -d --force-recreate
}

# Get the options
while [ "$1" != "" ]; do
    case $1 in
        -m | --mysql )
            _startContainer "${PROJECT_ROOT}/docker/dbs/mysql.yml" "${PROJECT_ROOT}/.env.mysql"
            ;;
        -p | --postgres )
            _startContainer "${PROJECT_ROOT}/docker/dbs/postgres.yml" "${PROJECT_ROOT}/.env.pgsql"
            ;;
        * )
            echo "Invalid option: $1"
            echo "Usage: stop-db [-m] [-p]"
            echo "     -m | --mysql start mysql db"
            echo "     -p | --postgres start postgres db"
            echo "     the command requires an argument"
            exit
            ;;
    esac
    shift
done